(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{199:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return i})),a.d(t,"metadata",(function(){return s})),a.d(t,"rightToc",(function(){return c})),a.d(t,"default",(function(){return d}));var n=a(2),r=a(9),o=(a(0),a(203)),i={id:"deploy-detection-nodered",title:"Deploy a Node-RED detection system",sidebar_label:"Deploy a Node-RED earthquake detection system"},s={id:"deploy-detection-nodered",title:"Deploy a Node-RED detection system",description:"\ud83d\udc49\ud83c\udffc Please also refer to the accompanying Github Repository.",source:"@site/docs/deploy-detection-nodered.md",permalink:"/docs/deploy-detection-nodered",editUrl:"https://github.com/openeew/openeew-docs/edit/master/docs/deploy-detection-nodered.md",sidebar_label:"Deploy a Node-RED earthquake detection system",sidebar:"someSidebar",previous:{title:"Deploy an earthquake detection system",permalink:"/docs/deploy-detection-docker"},next:{title:"Create a monitoring dashboard",permalink:"/docs/create-dashboard"}},c=[{value:"Node-RED",id:"node-red",children:[{value:"Install Node-RED",id:"install-node-red",children:[]},{value:"Reading OpenEEW sensor data",id:"reading-openeew-sensor-data",children:[]},{value:"Detecting peak accelerations (PGAs)",id:"detecting-peak-accelerations-pgas",children:[]},{value:"Using STA/LTA",id:"using-stalta",children:[]}]}],l={rightToc:c};function d(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(n.a)({},l,a,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"\ud83d\udc49\ud83c\udffc Please also refer to the accompanying ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/openeew/openeew-nodered"}),"Github Repository"),"."),Object(o.b)("p",null,"There are various methods you can use to ingest sensor data and output an EEW alert. Here we provide an example with ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"#node-red"}),"Node-Red"),", but you can also run the OpenEEW ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/deploy-detection-docker"}),"Docker container"),"."),Object(o.b)("h2",{id:"node-red"},"Node-RED"),Object(o.b)("p",null,"Node-RED is a low-code tool for working with IoT data. It natively works with the JSON format which the OpenEEW sensor outputs, making it fast and easy to use. It also provides plugins, called ",Object(o.b)("inlineCode",{parentName:"p"},"nodes"),", that can take data from an MQTT broker, output to email, write to a database, and much more."),Object(o.b)("p",null,"This tool allows you to make ",Object(o.b)("inlineCode",{parentName:"p"},"flows")," which are visual representations of data being processed. We encourage you to use the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/openeew/openeew-nodered"}),"flows we create"),", and share flows that you have made."),Object(o.b)("p",null,Object(o.b)("img",Object(n.a)({parentName:"p"},{src:"/docs/openeew-quakeplayback-flow.png",alt:"openeew-quakeplayback-flow"}))),Object(o.b)("p",null,"Whilst most of what you may want to do requires simply connecting and configuring the ",Object(o.b)("inlineCode",{parentName:"p"},"nodes"),", for advanced work such as creating new ",Object(o.b)("inlineCode",{parentName:"p"},"nodes")," with unique logic, ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://javascript.info/"}),"knowledge of JavaScript")," is useful."),Object(o.b)("h3",{id:"install-node-red"},"Install Node-RED"),Object(o.b)("p",null,"Node-RED can be installed on many systems, from a Raspberry Pi to a virtual machine in the cloud. You can find ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://nodered.org/docs/getting-started/"}),"instructions here"),"."),Object(o.b)("p",null,"For local deployment you can simply run an instance on a laptop, and when you are ready you can re-use your flows in a production environment. "),Object(o.b)("h3",{id:"reading-openeew-sensor-data"},"Reading OpenEEW sensor data"),Object(o.b)("p",null,"The very first task should be reading real-time data from your sensors. To do this you will need an MQTT node and the credentials for connecting to the MQTT broker. If you are reading directly from an OpenEEW cluster, then you can ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"#"}),"access the credentials here"),". If you are hosting your own MQTT broker, then you will use the credentials you have created."),Object(o.b)("p",null,"Simply connect your ",Object(o.b)("inlineCode",{parentName:"p"},"MQTT node")," with a ",Object(o.b)("inlineCode",{parentName:"p"},"debug node"),", and in the debug panel you will see your data live!"),Object(o.b)("p",null,Object(o.b)("img",Object(n.a)({parentName:"p"},{src:"/docs/nodered-stream1.gif",alt:null}))),Object(o.b)("p",null,"Each sensors sends a single message per second, with the following structure:"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),'{"traces":\n    [{"t":1518824421.406080,"sr":125,     //\'t\'=time, \'sr\'=sample rate\n      "x": [2.723, 2.293, 2.75, ...],     //32 samples per second\n      "y": [3.134, 1.686, -4.081, ...],   //32 samples per second\n      "z": [10.636, 13.891, 13.084, ...]  //32 samples per second\n     },...  \n     //4 arrays in total\n    ]}\n')),Object(o.b)("p",null,"The timestamp from the moment each array of 32 readings is received by the accelerometer is denoted by ",Object(o.b)("inlineCode",{parentName:"p"},"t"),". The sensor rate, typically 32hz or 125hz, is denoted by ",Object(o.b)("inlineCode",{parentName:"p"},"sr"),". The individual accelerations are found in their respective axis, ",Object(o.b)("inlineCode",{parentName:"p"},"x"),", ",Object(o.b)("inlineCode",{parentName:"p"},"y"),", or ",Object(o.b)("inlineCode",{parentName:"p"},"z"),". The accelerations are in ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/Gal_(unit)"}),"gal units"),", where ",Object(o.b)("em",{parentName:"p"},"1 gal")," equals ",Object(o.b)("em",{parentName:"p"},"1 cm/s2"),"."),Object(o.b)("h3",{id:"detecting-peak-accelerations-pgas"},"Detecting peak accelerations (PGAs)"),Object(o.b)("p",null,"As a simple trigger, you can simply set a threshold that alerts on high accelerations from the sensors. The following code can be inserted into a ",Object(o.b)("inlineCode",{parentName:"p"},"function node"),":"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"var alert = false;\nvar gals = 0.0;\nvar x,y,z;\nfor( i=0; i<msg.payload.traces[0].x.length;i++){\n    x = msg.payload.traces[0].x[i];\n    y = msg.payload.traces[0].y[i];\n    z = msg.payload.traces[0].z[i];\n\n    gals = Math.sqrt( Math.pow(x,2) + Math.pow(y,2) + Math.pow(z,2) );\n    if( gals > 3 ) {\n        // whoa - maybe an earthquake\n        alert = true\n    }\n}\n\nif( alert ) {\n    return msg;\n} else {\n    return null ;\n}\n")),Object(o.b)("p",null,"This node will declare an earthquake when it detects values above 3 gals. Of course this will not filter out accelerations from other events, such as passing vehicles or slamming doors."),Object(o.b)("h3",{id:"using-stalta"},"Using STA/LTA"),Object(o.b)("p",null,"Running the traces through an STA/LTA (Short-Term Average/Long-Term Average) node before the PGA node will help filter out non-earthquake accelerations."),Object(o.b)("p",null,"To create an STA/LTA function node, you will need to do the following:"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"Take the first 10 messages of data for each sensor (approximately 10s) and for each axis take the average of the absolute values."),Object(o.b)("li",{parentName:"ol"},"Take the final 1 message worth of data for each sensor (approximately 1s) from this same 10 message window and again take an average reading of the absolute values for each axis."),Object(o.b)("li",{parentName:"ol"},"The average value taken from the 1 message window should be divided by the value for the 10 message window.")),Object(o.b)("p",null,"Repeat this every second to obtain a new STA/LTA value. Experiment with ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/historic-data"}),"OpenEEW historic data")," to establish a good threshold for this value, based on the typical earthquake magnitudes in your region."))}d.isMDXComponent=!0},203:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return h}));var n=a(0),r=a.n(n);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=r.a.createContext({}),d=function(e){var t=r.a.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},p=function(e){var t=d(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},b=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,i=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=d(a),b=n,h=p["".concat(i,".").concat(b)]||p[b]||u[b]||o;return a?r.a.createElement(h,s(s({ref:t},l),{},{components:a})):r.a.createElement(h,s({ref:t},l))}));function h(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,i=new Array(o);i[0]=b;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:n,i[1]=s;for(var l=2;l<o;l++)i[l]=a[l];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,a)}b.displayName="MDXCreateElement"}}]);